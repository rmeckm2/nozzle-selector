<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Capstan PWM Nozzle Selector</title>
<style>
/* Advanced panel: lock options + header, scroll body */
#advancedPanel .content{
  display:flex;
  flex-direction:column;
  gap:8px;
}
#advOptionsRow{
  position:sticky;
  top:0;
  z-index:2;
  background:#fff;
  padding-top:4px;
  padding-bottom:4px;
  border-bottom:1px solid #eef1f5;
}
#advTableWrap{
  max-height: 60vh;
  overflow:auto;
  border-radius:10px;
  border:1px solid #e4e7ec;
  overscroll-behavior: contain; /* smoother scroll */
}
#advTableWrap thead th{
  position: sticky;
  top: 0;              /* <- always stick to top of the scroll area */
  background:#f8fafc;
  z-index: 1;
}

*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7f9;color:#222}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:#0b2b4c;color:#fff;position:sticky;top:0;z-index:10}
.title{font-weight:700}
/* Header controls (Units / Pressure / Outlet / Mode) */
.header-controls{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  justify-content:flex-end;
  font-size:12px;
}

.header-control{
  display:flex;
  align-items:center;
  gap:6px;
}

.header-control select{
  height:28px;
}

/* Hide metric pressure by default; JS will set inline display when needed */
#metricPressureWrap{
  display:none;
}

/* On very narrow screens, let the pairs wrap nicely */
@media (max-width:600px){
  .header-controls{
    justify-content:flex-start;
  }
}

.container{max-width:1100px;margin:20px auto;padding:0 16px}
.panel{background:#fff;border:1px solid #e4e7ec;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,.05);margin-bottom:16px}
.panel .header{
  padding:12px 14px;
  border-bottom:1px solid #eef1f5;
  font-weight:700;
  background:#f0f4fa;
  color:#0b2b4c;

  /* changed from flex to grid */
  display:grid;
  grid-template-columns:auto 1fr;  /* title | controls on wide screens */
  align-items:center;
  column-gap:12px;
}
.panel .content{padding:14px}
.form-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
/* Advanced options grid (desktop default) */
.adv-grid{
  grid-template-columns:repeat(4,1fr);
  gap:12px;
  align-items:end;
  margin-bottom:8px;
}
/* Header controls container (Units / Outlet / Mode) */
.header-controls{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:flex-end;
}

.header-control{
  display:flex;
  align-items:center;
  gap:6px;
}

/* Mobile: stack title above controls */
@media (max-width:700px){
  .panel .header{
    grid-template-columns:1fr;   /* title on its own row */
  }
  .panel .header > span{
    margin-bottom:6px;
  }
  .header-controls{
    justify-content:flex-start;
  }
}
.form-item{display:flex;flex-direction:column;gap:6px}
label{font-size:12px;color:#444}
input,select{height:36px;padding:6px 10px;border:1px solid #d9dde3;border-radius:8px;background:#fff}
.hint{font-size:12px;color:#667085}
.cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.card{background:#fff;border:1px solid #e4e7ec;border-radius:12px;padding:14px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;background:#eef4ff;color:#134fba}
.kv{display:grid;grid-template-columns:1fr auto;gap:6px;font-size:13px}
.kv div{display:flex;justify-content:space-between;border-bottom:1px dashed #eef1f5;padding:4px 0}
.help{font-size:12px;color:#667085}
.table{width:100%;border-collapse:collapse}
.table th,.table td{text-align:left;padding:10px;border-bottom:1px solid #eef1f5;font-size:13px;vertical-align:top}
.table th{background:#f8fafc;font-weight:600}
.status{font-size:12px;padding:2px 8px;border-radius:10px;display:inline-block}
.ok{background:#ecfdf3;color:#027a48;border:1px solid #a7f3d0}
.warn{background:#fff7ed;color:#b45309;border:1px solid #fed7aa}
.bad{background:#fef2f2;color:#b91c1c;border:1px solid #fecaca}
.footer{color:#98a2b3;font-size:12px;text-align:center;padding:20px 6px}
@media (max-width:900px){   .form-grid{grid-template-columns:1fr 1fr}   .cards{grid-template-columns:1fr}   /* Advanced row: only two columns on small screens */   .adv-grid{grid-template-columns:1fr 1fr} }  /* Extra-small phones: stack advanced controls in one column */ @media (max-width:600px){   .adv-grid{grid-template-columns:1fr} }
/* Card spacing & single-line values */
.kv .value { text-align:right; white-space:nowrap; }
.kv .label span { white-space:nowrap; }
.kv .label { color:#555; }
.metric-big { font-size:20px; font-weight:700; line-height:1; }
.metric-sub { font-size:12px; color:#667085; }

/* Print cleanup */
@media print {
  header { position: static; background:#fff; color:#000; border-bottom:1px solid #ddd; }
  .panel { box-shadow:none; border-color:#ccc; page-break-inside: avoid; }
  #printBtn { display:none; }
  body { background:#fff; }
}

/* Top Picks: center tiles + keep labels on one line */
.metric-box{display:flex;flex-direction:column;align-items:center}
.metric-big{font-size:20px;font-weight:700;line-height:1}
.metric-sub{font-size:12px;color:#667085}
.kv .value{ text-align:right; white-space:nowrap; }
.kv .label span{ white-space:nowrap; }

/* Size filter dropdown */
#sizeFilterWrap{position:relative}
#sizeFilterBtn{height:36px;padding:6px 10px;border:1px solid #d9dde3;border-radius:8px;background:#fff;cursor:pointer}
#sizeFilterPanel{position:absolute;top:66px;left:0;z-index:5;display:none;min-width:260px;
  background:#fff;border:1px solid #d9dde3;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:10px}
#sizeFilterPanel.open{display:block}
#sizeFilterList{max-height:220px;overflow:auto;padding:4px 0}
#sizeFilterList label{display:flex;align-items:center;gap:8px;padding:6px 8px;font-size:13px}
#sizeFilterPanel .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:8px}
#sizeFilterApply,#sizeFilterClear{height:30px;padding:0 10px;border:1px solid #d9dde3;border-radius:8px;background:#fff;cursor:pointer}

/* Make helper text reserve equal space under every control */
.form-item .hint{
  display:block;
  min-height:18px;
  line-height:18px;
  margin-top:6px;
}

/* ==== Disk mode: group stripes by disk (Blue/White alternating) ==== */
.disk-row-blue  { background: rgba(29, 78, 216, 0.08); } /* #1D4ED8 @ 8% */
.disk-left-blue { border-left: 6px solid #1D4ED8; }

.disk-row-white  { background: #fff; }
.disk-left-white { border-left: 6px solid #fff; }        /* blends with row */

.disk-pill {
  display:inline-block;
  font-variant-numeric: tabular-nums;
  padding:2px 6px;
  border-radius:6px;
  border:1px solid rgba(0,0,0,0.15);
  background:#fff;
}
@media (max-width:900px){
  #advTableWrap{
    max-height:none;       /* let it grow full height */
    overflow-y:visible;    /* no inner vertical scroll */
    overflow-x:auto;       /* still allow horizontal scroll if needed */
  }
}
/* ===== MOBILE TABLE BEHAVIOR FIX ===== */
@media (max-width:900px){

  /* No inner vertical scroll on mobile */
  #advTableWrap{
    max-height: none;
    overflow-y: visible;
    overflow-x: auto;
  }

  /* Turn OFF sticky header on mobile to avoid floating/overlap */
  #advTableWrap thead,
  #advTableWrap thead th{
    position: static;
    top: auto;
  }
}
</style>
</head>
<body>
<header>
  <div class="title">CapstanAG • PWM Nozzle Selector</div>
  <button id="printBtn"
    style="height:32px;padding:0 12px;border:1px solid #d9dde3;border-radius:8px;background:#fff;cursor:pointer;">
    Print
  </button>
</header>


<div class="container">

  <!-- Application Setup -->
  <section class="panel">
  <div class="header">
    <span>Application Setup</span>
    <div class="header-controls">
      <div class="header-control">
        <label>Units:</label>
        <select id="unitSystem">
          <option value="us" selected>US</option>
          <option value="metric">Metric</option>
        </select>
      </div>

      <div id="metricPressureWrap" class="header-control">
        <label>Pressure:</label>
        <select id="metricPressureUnit">
          <option value="kpa" selected>kPa</option>
          <option value="bar">bar</option>
        </select>
      </div>

      <div class="header-control">
        <label>Outlet:</label>
        <select id="outletType">
          <option value="nozzle">Spray Nozzle</option>
          <option value="disk">Orifice Disk</option>
        </select>
      </div>

      <div class="header-control">
        <label>Mode:</label>
        <select id="modeToggle">
          <option value="basic">Basic</option>
          <option value="advanced">Advanced</option>
        </select>
      </div>
    </div>
  </div>

    <div class="content">
      <div class="form-grid">
        <div class="form-item">
  <label>Application Type</label>
  <select id="appType">
    <option value="field">Field</option>
    <option value="orchard">Orchard</option>
    <option value="turf">Turf</option>
  </select>
</div>


        <div class="form-item">
          <label id="labelTargetRate">Target Rate (gpa)</label>
          <input id="targetRate" value="10" />
        </div>
        <div class="form-item">
          <label>Nozzle Spacing (in)</label>
          <input id="spacingIn" value="20" />
        </div>
        <div class="form-item">
          <label>Valve Family</label>
          <select id="valveFamily">
            <option value="15">15 Series (Black Wire)</option>
            <option value="24" selected>24 Series (Blue Wire)</option>
          </select>
        </div>

        <div class="form-item">
          <label>P1 (psi)</label>
          <select id="boomPsi">
            <optgroup label="Field/Turf">
              <option>20</option><option>30</option><option>40</option><option>50</option>
              <option selected>60</option><option>70</option><option>80</option>
            </optgroup>
            <optgroup label="Orchard">
              <option>100</option><option>120</option><option>140</option><option>160</option><option>180</option>
            </optgroup>
          </select>
        </div>

        <div class="form-item">
          <label>P2 (psi)</label>
          <select id="boomPsi2">
            <optgroup label="Field/Turf">
              <option selected>20</option><option>30</option><option>40</option>
              <option>50</option><option>60</option><option>70</option><option>80</option>
            </optgroup>
            <optgroup label="Orchard">
              <option>100</option><option>120</option><option>140</option><option>160</option><option>180</option>
            </optgroup>
          </select>
        </div>

        <div class="form-item">
          <label>Max Travel Speed (mph)</label>
          <input id="vmax" value="18" />
        </div>
        <div class="form-item">
          <label>Fluid Specific Gravity</label>
          <select id="sg">
            <option value="1.00">Water (1.00)</option>
            <option value="1.28">28% UAN (1.28)</option>
            <option value="1.32">32% UAN (1.32)</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <!-- Top Picks -->
  <section class="panel">
    <div class="header" style="justify-content:space-between;">
      <span>Top Picks</span>
      <span class="hint" style="font-weight:400;">Click Card for More Information</span>
    </div>
    <div class="content">
      <div class="cards" id="topCards"></div>
    </div>
  </section>

  <!-- Advanced -->
  <section class="panel" id="advancedPanel">
    <div class="header">
      <span>Advanced Options & Table</span>
      <span></span>
    </div>
    <div class="content">
      <div id="advOptionsRow" class="form-grid adv-grid">

        <!-- Filter chooser -->
        <div class="form-item" id="sizeFilterWrap" style="position:relative;">
          <label id="sizeFilterLabel">Filter Nozzle Sizes</label>
          <button id="sizeFilterBtn" type="button">Choose sizes</button>
          <div class="hint" id="sizeFilterSummary" style="margin-top:6px;">All sizes shown</div>

          <!-- anchored dropdown panel -->
          <div id="sizeFilterPanel" style="position:absolute; top:calc(100% + 8px); left:0;">
            <div id="sizeFilterSearchWrap" style="display:none; margin-bottom:6px;">
              <input id="sizeFilterSearch" placeholder="Search disks..." style="width:100%;height:30px;padding:4px 8px;border:1px solid #d9dde3;border-radius:6px;">
            </div>
            <div id="sizeFilterList"><!-- checkboxes injected --></div>
            <div class="actions" style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px;">
              <button id="sizeFilterApply" type="button">Apply</button>
              <button id="sizeFilterClear" type="button">Clear</button>
            </div>
          </div>
        </div>

        <!-- Min Duty -->
        <div class="form-item" style="align-self:end;">
          <label>Min Duty Cycle (%)</label>
          <input id="dcmin" value="25" />
          <div class="hint" aria-hidden="true"></div>
        </div>

        <!-- Custom PSI -->
        <div class="form-item" style="align-self:end;">
          <label>Custom Boom PSI</label>
          <input id="customPb" placeholder="e.g., 32 (optional override)" />
          <div class="hint" aria-hidden="true"></div>
        </div>

        <!-- Custom outlet -->
        <div class="form-item" style="align-self:end;">
          <label id="customNozLbl">Custom Nozzle Size (GPM @ 40 psi)</label>
          <input id="customNoz" placeholder="e.g., 0.55 (optional)" />
          <div class="hint" id="customHint">Assumes Black if > 2.0</div>
        </div>

      </div>

      <div id="advTableWrap">
        <table class="table" id="resultsTable">
          <thead>
            <tr>
              <th>Boom Pressure</th>
              <th id="colNameHeader">Size • Color<br><span class="hint">GPM @ 40 psi (water)</span></th>
              <th id="colNozPressHeader">Nozzle Pressure</th>
              <th>Min Speed</th>
              <th>Max Speed</th>
              <th>DC @ Max Speed</th>
              <th>Fit @ Max Speed</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>
</div>


<script>
// --------- Data & Math ---------
const VALVES = {
  "15": { id:"15", label:"15 Series (Black Wire)", Cv: 0.245 },
  "24": { id:"24", label:"24 Series (Blue Wire)",  Cv: 0.38  },
};

// Extended nozzle list incl. 1.25 and 3.00 (Black by rule for 3.00)
const BASE_NOZZLES = [
  { code:"01",  color:"Orange",     size:0.10 },
  { code:"015", color:"Green",      size:0.15 },
  { code:"02",  color:"Yellow",     size:0.20 },
  { code:"025", color:"Lilac",      size:0.25 },
  { code:"03",  color:"Blue",       size:0.30 },
  { code:"035", color:"Brown Red",  size:0.35 },
  { code:"04",  color:"Red",        size:0.40 },
  { code:"05",  color:"Brown",      size:0.50 },
  { code:"06",  color:"Gray",       size:0.60 },
  { code:"08",  color:"White",      size:0.80 },
  { code:"10",  color:"Light Blue", size:1.00 },
  { code:"125", color:"Teal",       size:1.25 },
  { code:"15",  color:"Light Green",size:1.50 },
  { code:"20",  color:"Black",      size:2.00 },
  { code:"30",  color:"Black",      size:3.00 }
];

const COLOR_MAP = {
  "Orange":"#F97316","Green":"#16A34A","Yellow":"#EAB308","Lilac":"#C084FC","Blue":"#2563EB","Brown Red":"#9A3412",
  "Red":"#DC2626","Brown":"#92400E","Gray":"#6B7280","White":"#FFFFFF","Light Blue":"#38BDF8","Light Green":"#86EFAC",
  "Black":"#111827","Teal":"#0E5866"
};

const PRESSURE_RULES = {
  field:   { pnIdeal:[30,50], recMax:60, absMax:80, min:null },
  turf:    { pnIdeal:[30,50], recMax:60, absMax:80, min:null },
  orchard: { pnIdeal:[100,160], recMax:180, absMax:180, min:100 },
};

// ---- NEW: Orifice Disk catalog (size = GPM @ 40psi, water)
const ORIFICE_DISKS = [
  { id:"CP4916-008", size:0.008 }, { id:"CP4916-10", size:0.013 },
  { id:"CP4916-12", size:0.019 }, { id:"CP4916-14", size:0.025 },
  { id:"CP4916-15", size:0.029 }, { id:"CP4916-16", size:0.033 },
  { id:"CP4916-18", size:0.042 }, { id:"CP4916-20", size:0.052 },
  { id:"CP4916-22", size:0.061 }, { id:"CP4916-24", size:0.074 },
  { id:"CP4916-25", size:0.079 }, { id:"CP4916-26", size:0.086 },
  { id:"CP4916-27", size:0.091 }, { id:"CP4916-28", size:0.098 },
  { id:"CP4916-29", size:0.108 }, { id:"CP4916-30", size:0.114 },
  { id:"CP4916-31", size:0.123 }, { id:"CP4916-32", size:0.135 },
  { id:"CP4916-34", size:0.147 }, { id:"CP4916-35", size:0.157 },
  { id:"CP4916-37", size:0.172 }, { id:"CP4916-39", size:0.191 },
  { id:"CP4916-40", size:0.204 }, { id:"CP4916-41", size:0.211 },
  { id:"CP4916-43", size:0.231 }, { id:"CP4916-45", size:0.25  },
  { id:"CP4916-46", size:0.27  }, { id:"CP4916-47", size:0.275 },
  { id:"CP4916-48", size:0.286 }, { id:"CP4916-49", size:0.295 },
  { id:"CP4916-51", size:0.329 }, { id:"CP4916-52", size:0.335 },
  { id:"CP4916-54", size:0.36  }, { id:"CP4916-55", size:0.377 },
  { id:"CP4916-57", size:0.4   }, { id:"CP4916-59", size:0.433 },
  { id:"CP4916-61", size:0.466 }, { id:"CP4916-63", size:0.491 },
  { id:"CP4916-65", size:0.522 }, { id:"CP4916-67", size:0.555 },
  { id:"CP4916-68", size:0.573 }, { id:"CP4916-70", size:0.612 },
  { id:"CP4916-72", size:0.64  }, { id:"CP4916-73", size:0.66  },
  { id:"CP4916-75", size:0.694 }, { id:"CP4916-78", size:0.77  },
  { id:"CP4916-80", size:0.793 }, { id:"CP4916-81", size:0.821 },
  { id:"CP4916-83", size:0.897 }, { id:"CP4916-86", size:0.939 },
  { id:"CP4916-89", size:0.98  }, { id:"CP4916-91", size:1.05  },
  { id:"CP4916-93", size:1.09  }, { id:"CP4916-95", size:1.14  },
  { id:"CP4916-98", size:1.25  }, { id:"CP4916-103",size:1.31  },
  { id:"CP4916-107",size:1.47  }, { id:"CP4916-110",size:1.55  },
  { id:"CP4916-115",size:1.71  }, { id:"CP4916-120",size:1.78  },
  { id:"CP4916-125",size:1.96  }, { id:"CP4916-128",size:2.04  },
  { id:"CP4916-132",size:2.19  }, { id:"CP4916-136",size:2.38  },
  { id:"CP4916-140",size:2.53  }, { id:"CP4916-144",size:2.62  },
  { id:"CP4916-147",size:2.7   }, { id:"CP4916-151",size:2.94  },
  { id:"CP4916-156",size:3.11  }, { id:"CP4916-161",size:3.27  },
  { id:"CP4916-166",size:3.43  }, { id:"CP4916-170",size:3.69  },
  { id:"CP4916-172",size:3.84  }, { id:"CP4916-177",size:4.00  },
  { id:"CP4916-182",size:4.17  }, { id:"CP4916-187",size:4.41  },
  { id:"CP4916-196",size:4.90  }, { id:"CP4916-205",size:5.31  },
  { id:"CP4916-218",size:5.96  }, { id:"CP4916-234",size:6.94  },
  { id:"CP4916-250",size:8.00  },
];

const $ = (id)=>document.getElementById(id);
const toNum = (v, fb=0)=>{ const x=parseFloat(String(v).trim()); return isNaN(x)?fb:x; };

// Unit helpers
function isMetric(){ return $('unitSystem').value === 'metric'; }
function pressureDisplayUnit(){
  if(!isMetric()) return 'psi';
  return $('metricPressureUnit').value; // kpa or bar
}

// --- NEW: Outlet Type helpers
function getOutletType(){
  const el = $('outletType');
  return el ? el.value : 'nozzle';
}
function isDiskMode(){ return getOutletType() === 'disk'; }
function getActiveOutlets(){
  return isDiskMode() ? ORIFICE_DISKS : BASE_NOZZLES;
}
function fmtGpm40(x){ return (x>=1 ? x.toFixed(2) : x.toFixed(3)) + ' GPM @40'; }
function getOutletName(o){ return isDiskMode() ? o.id : (o.name || o.code || String(o.size)); }
function getOutletSize(o){ return isDiskMode() ? o.size : (o.size ?? o.N40); }
function getOutletLabel(o){
  if(isDiskMode()){
    return `${o.id} • ${fmtGpm40(o.size)}`;
  } else {
    const sz = getOutletSize(o);
    const color = o.color ? ` • ${o.color}` : '';
    return `Size ${(+sz).toFixed(2)}${color}`;
  }
}
function diskAccentClass(idOrName){
  const s = String(idOrName||''); let h=0;
  for(let i=0;i<s.length;i++){ h = (h*31 + s.charCodeAt(i)) & 0xffff; }
  const ix = h % 4;
  return ['disk-edge-a','disk-edge-b','disk-edge-c','disk-edge-d'][ix];
}

// --- Conversions
const CM_PER_IN = 2.54;
const LHA_PER_GPA = 9.353;            // 1 GPA = 9.353 L/ha
const MPH_PER_KPH = 0.621371;

function getRateUS(){ // returns GPA for math
  const v = toNum($('targetRate').value, 0);
  return isMetric() ? (v / LHA_PER_GPA) : v;
}
function getSpacingInches(){ // returns inches for math
  const v = toNum($('spacingIn').value, 20);
  return isMetric() ? (v / CM_PER_IN) : v;
}
function getVmaxMph(){ // returns mph for math
  const v = toNum($('vmax').value, 18);
  return isMetric() ? (v * MPH_PER_KPH) : v;
}

// Pressure display + conversion
function displayPressureLabel(){
  const u = pressureDisplayUnit();
  return (u==='psi'?'PSI':(u==='kpa'?'kPa':'bar'));
}
function psiToDisplay(psi){
  const u = pressureDisplayUnit();
  if(u==='kpa') return psi*6.89476;
  if(u==='bar') return psi*0.0689476;
  return psi;
}
function displayToPsi(v){
  const u = pressureDisplayUnit();
  const x = toNum(v, 0);
  if(u==='kpa') return x/6.89476;
  if(u==='bar') return x/0.0689476;
  return x;
}
function mphToDisplay(mph){ return isMetric() ? (mph/MPH_PER_KPH) : mph; }
function formatPressureDisplay(val){
  const u = pressureDisplayUnit();
  return (u==='bar') ? Number(val).toFixed(2) : Math.round(val);
}
function getSelectedPsi(sel){
  const opt = sel?.selectedOptions?.[0];
  if(opt && opt.dataset.psi) return toNum(opt.dataset.psi, 0);
  return toNum(sel?.value, 0);
}
function fmtPressureValue(psi){ return Math.round(psiToDisplay(psi)); }
function fmtPressureValueTable(psi){
  const u=pressureDisplayUnit();
  const v=psiToDisplay(psi);
  return (u==='bar')?v.toFixed(2):String(Math.round(v));
}

function updateUnitLabels(){
  const appType = $('appType').value;
  const hintEl = document.querySelector('header .hint');
  if(hintEl) hintEl.textContent = (isMetric() ? 'Metric Units • Auto-calculates on change' : 'US Units • Auto-calculates on change');

  // Target Rate label
  $('labelTargetRate').textContent = isMetric()
    ? 'Target Rate (L/ha)'
    : (appType==='turf' ? 'Target Rate (gpk)' : 'Target Rate (gpa)');

  // Spacing label
  const spacingLabel = $('spacingIn')?.previousElementSibling;
  if(spacingLabel) spacingLabel.textContent = isMetric() ? 'Nozzle Spacing (cm)' : 'Nozzle Spacing (in)';

  // Max speed label
  const vmaxLabel = $('vmax')?.previousElementSibling;
  if(vmaxLabel) vmaxLabel.textContent = isMetric() ? 'Max Travel Speed (kph)' : 'Max Travel Speed (mph)';

  // Show metric pressure unit selector when Metric
  $('metricPressureWrap').style.display = isMetric()? 'inline-flex' : 'none';

  // P1/P2 label text swap to active pressure unit
  const p1Label = $('boomPsi')?.previousElementSibling;
  const p2Label = $('boomPsi2')?.previousElementSibling;
  const unitTxt = pressureDisplayUnit();
  if(p1Label) p1Label.textContent = `P1 (${unitTxt})`;
  if(p2Label) p2Label.textContent = `P2 (${unitTxt})`;

  // Custom pressure label
  const customPbLabel = $('customPb')?.previousElementSibling;
  if(customPbLabel) customPbLabel.textContent = `Custom Boom ${isMetric() ? (unitTxt.toUpperCase()) : 'PSI'}`;

  // Custom outlet label (toggle)
  const customLbl = $('customNozLbl');
  const customHint = $('customHint');
  if(customLbl) customLbl.textContent = isDiskMode() ? 'Custom Disk Flow (GPM @ 40 psi)' : 'Custom Nozzle Size (GPM @ 40 psi)';
  if(customHint) customHint.textContent = isDiskMode() ? 'Enter a disk flow at 40 psi' : 'Assumes Black if > 2.0';

  // Advanced header column name
  const nameHeader = $('colNameHeader');
  const nozPressHdr = $('colNozPressHeader');
  if(nameHeader){
    nameHeader.innerHTML = isDiskMode()
      ? 'Orifice Disk • Name<br><span class="hint">GPM @ 40 psi (water)</span>'
      : 'Size • Color<br><span class="hint">GPM @ 40 psi (water)</span>';
  }
  if(nozPressHdr){
    nozPressHdr.textContent = isDiskMode() ? 'Orifice Pressure' : 'Nozzle Pressure';
  }

  updatePressureDropdownDisplays();
}
function ensurePressureOptionsPSI(){
  ['boomPsi','boomPsi2'].forEach(id=>{
    const sel = $(id); if(!sel) return;
    Array.from(sel.options).forEach(opt=>{
      if(!opt.dataset.psi){
        const psi = toNum(opt.value || opt.textContent, 0);
        opt.dataset.psi = String(psi);
      }
      opt.value = opt.dataset.psi; // keep value in PSI
    });
  });
}
function updatePressureDropdownDisplays(){
  const unit = pressureDisplayUnit();
  const selects = [ $('boomPsi'), $('boomPsi2') ].filter(Boolean);
  selects.forEach(sel=>{
    Array.from(sel.options).forEach(opt=>{
      const psiVal = toNum(opt.dataset.psi || opt.value || opt.textContent, 0);
      let txt;
      if(unit==='kpa')      txt = Math.round(psiVal * 6.89476).toString();
      else if(unit==='bar') txt = (psiVal * 0.0689476).toFixed(2);
      else                  txt = String(psiVal);
      opt.textContent = txt;
      opt.value = String(psiVal);
    });
  });
}

// Core math
function nozzlePressureFromBoom(Pb, N40, Cv){
  const k = N40/Math.sqrt(40);
  const denom = 1 + (k*k)/(Cv*Cv);
  return Pb/denom;
}
function nozzleFlowAt(Pn, SG, N40){
  return N40 * Math.sqrt(Math.max(Pn,0)/(40*SG));
}
function requiredFlowUS(appType, rate, mph, spacingIn){
  if(appType==='turf'){ return (rate * mph * spacingIn) / 136.4; } // GPK
  return (rate * mph * spacingIn) / 5940; // GPA
}
function dutyAtSpeed(appType, rate, mph, spacingIn, Qnoz){
  const req = requiredFlowUS(appType, rate, mph, spacingIn);
  return Qnoz>0 ? (req/Qnoz) : Infinity;
}
function speedsFromQ(appType, rate, spacingIn, Qnoz, dcMin){
  if(Qnoz<=0) return {v100:0,vmin:0};
  const constUS = (appType==='turf')?136.4:5940;
  const v100 = (constUS * Qnoz) / (rate * spacingIn);
  const vmin = dcMin * v100;
  return {v100, vmin};
}

// Selection logic for Top Picks centered on Vmax
function buildOutletList(includeCustom){
  const base = getActiveOutlets().map(o=>{
    // Normalize to common shape
    if(isDiskMode()){
      return { id:o.id, size:o.size, type:'disk', isCustom:false };
    } else {
      return { code:o.code, color:o.color, size:o.size, type:'nozzle', isCustom:false };
    }
  });
  if(includeCustom){
    const c = $('customNoz').value.trim();
    if(c){
      const sz = parseFloat(c);
      if(!isNaN(sz) && sz>0){
        if(isDiskMode()){
          base.unshift({ id:'CUSTOM', size:sz, type:'disk', isCustom:true, label:'Custom Disk' });
        } else {
          base.unshift({ code:'CUSTOM', color:'Black', size:sz, type:'nozzle', isCustom:true, label:'Custom Nozzle' });
        }
      }
    }
  }
  base.sort((a,b)=>a.size-b.size);
  return base;
}

function pressureStepsForTable(appType){
  return (appType==='orchard') ? [100,120,140,160,180] : [20,30,40,50,60,70,80];
}
function selectTopPicks(rows, vmax){
  if(rows.length===0) return [];
  rows.sort((a,b)=>a.nz.size - b.nz.size);
  const below = rows.filter(r=>r.v100 < vmax);
  const above = rows.filter(r=>r.v100 >= vmax);
  let middle=null;
  if(above.length>0){ above.sort((a,b)=>(a.v100 - vmax)-(b.v100 - vmax)); middle=above[0]; }
  else { below.sort((a,b)=>b.v100 - a.v100); middle=below[0]; }
  const idx = rows.findIndex(r=>r.nz.size===middle.nz.size);
  let left= null, right=null;
  for(let i=idx-1;i>=0;i--){ left = rows[i]; break; }
  for(let i=idx+1;i<rows.length;i++){ right = rows[i]; break; }
  const picks=[]; if(left) picks.push(left); picks.push(middle); if(right) picks.push(right);
  const seen=new Set(); return picks.filter(p=>{ if(seen.has(p.nz.size)) return false; seen.add(p.nz.size); return true; }).slice(0,3);
}
function rationaleByPosition(pos){
  if(pos===0) return "Near-miss under: just below your maximum speed.";
  if(pos===1) return "Best fit at your maximum speed: minimal headroom.";
  return "Oversized option: provides headroom and allows lower PSI at maximum speed.";
}

function speedRangeAtBoom(boomPsi, appType, rate, spacingIn, sg, valve, nz, dcMin){
  const Pn = nozzlePressureFromBoom(boomPsi, nz.size, valve.Cv);
  const Qnoz = nozzleFlowAt(Pn, sg, nz.size);
  return speedsFromQ(appType, rate, spacingIn, Qnoz, dcMin);
}

// --- Decouple Top Picks from Advanced ---
const TOPPICKS_DCMIN = 0.25; // fixed 25% duty for Top Picks
function getP1PsiRaw(){ return getSelectedPsi($('boomPsi')) || 40; }
const TOPPICKS_SELECT_PSI = 60;

// Recalc & render
function recalc(){
  const appType = $('appType').value;
  const rate = getRateUS();
  const spacingIn = getSpacingInches();
  const valve = VALVES[$('valveFamily').value];
  const sg = toNum($('sg').value, 1.0);
  let Pb = displayToPsi($('customPb').value);
  if(!(Pb>0)) Pb = toNum($('boomPsi').value, 40);
  const vmax = getVmaxMph();
  const dcMin = Math.max(0, Math.min(1, toNum($('dcmin').value, 25)/100));
  const _rules = PRESSURE_RULES[appType] || PRESSURE_RULES.field;

  // Top Picks (fixed baseline)
  const outletsTop = buildOutletList(false);
  const PbTop = TOPPICKS_SELECT_PSI;
  const dcMinTop = TOPPICKS_DCMIN;
  const allRowsTop = [];
  for(const nz of outletsTop){
    const Pn = nozzlePressureFromBoom(PbTop, nz.size, valve.Cv);
    const Qnoz = nozzleFlowAt(Pn, sg, nz.size);
    const {v100, vmin} = speedsFromQ(appType, rate, spacingIn, Qnoz, dcMinTop);
    const dcVmax = dutyAtSpeed(appType, rate, vmax, spacingIn, Qnoz);
    allRowsTop.push({ nz, Pn, Qnoz, v100, vmin, dcVmax });
  }
  const picks = selectTopPicks(allRowsTop, vmax);
  renderTopCards(picks, vmax, dcMinTop);

  // Table
  renderTable();
  // (re)bind instant scroll immediately after DOM updates
  // rAF ensures layout is committed before we attach
  requestAnimationFrame(()=> enableAdvTableWheelScroll());
  // lock options row
  updateAdvStickyOffsets();
}

function buildDetailsTableRows(appType, rate, spacingIn, sg, valve, nz, psi, isTop=false){
  const Pn = nozzlePressureFromBoom(psi, nz.size, valve.Cv);
  const Q  = nozzleFlowAt(Pn, sg, nz.size);
  const v100 = speedsFromQ(appType, rate, spacingIn, Q, 1).v100; // base
  const dcs = [0.10,0.25,0.50,0.75,1.00];
  const speeds = dcs.map(dc => (v100*dc));
  const unitPress = displayPressureLabel();

  const nameCell = isDiskMode()
    ? (isTop ? `${getOutletName(nz)}` : `<span class="disk-pill">${getOutletName(nz)}</span><div class="sub">${fmtGpm40(getOutletSize(nz))}</div>`)
    : `${nz.isCustom ? 'Custom Nozzle' : ('Size ' + nz.size.toFixed(2))}${nz.isCustom?'':(' • '+(nz.color||''))}`;

  return `
    <tr>
      <td>${fmtPressureValueTable(psi)} ${unitPress}</td>
      <td>${nameCell}</td>
      <td>${fmtPressureValueTable(Pn)} ${unitPress}</td>
      <td>${mphToDisplay(speeds[0]).toFixed(2)}</td>
      <td>${mphToDisplay(speeds[1]).toFixed(2)}</td>
      <td>${mphToDisplay(speeds[2]).toFixed(2)}</td>
      <td>${mphToDisplay(speeds[3]).toFixed(2)}</td>
      <td>${mphToDisplay(speeds[4]).toFixed(2)}</td>
    </tr>
  `;
}

function renderTopCards(picks, vmax, dcMin){
  const wrap = $('topCards');
  if(!wrap){ console.warn('Missing #topCards container'); return; }
  wrap.innerHTML='';

  if(picks.length===0){
    wrap.innerHTML = '<div class="help">No outlets meet your maximum speed duty bounds. Try raising boom pressure, upsizing outlet, or lowering maximum speed.</div>';
    return;
  }
  const appType = $('appType').value;
  const rate = getRateUS();
  const spacingIn = getSpacingInches();
  const valve = VALVES[$('valveFamily').value];
  const sg = toNum($('sg').value, 1.0);
  const unitPress = displayPressureLabel();

  const P1 = getP1PsiRaw();
  const P2 = getP2Psi();

  picks.forEach((r,i)=>{
    const PnP1 = nozzlePressureFromBoom(P1, r.nz.size, valve.Cv);
    const p1NozDisp = formatPressureDisplay( psiToDisplay(PnP1) );

    const card = document.createElement('div');
    card.className='card';
    card.style.cursor = 'pointer';

    const badge = isDiskMode()
      ? `${getOutletName(r.nz)} • ${fmtGpm40(getOutletSize(r.nz))}`
      : `Size ${r.nz.size.toFixed(2)} • ${r.nz.isCustom ? 'Custom Nozzle' : (r.nz.color||'')}`;

    // compute speed ranges @ P1 and @ P2
    const sP1 = speedRangeAtBoom(P1, appType, rate, spacingIn, sg, valve, r.nz, dcMin);
    const sP2 = (P2 ? speedRangeAtBoom(P2, appType, rate, spacingIn, sg, valve, r.nz, dcMin) : null);

    const headroomPct = ((r.v100 - vmax)/Math.max(vmax,1e-6)*100);
    const headroomStr = (headroomPct>=0?'+':'') + Math.round(headroomPct) + '%';

    const detailsId = 'det_' + Math.random().toString(36).slice(2);

    card.innerHTML = `
      <div class="badge">${badge}</div>

      <div class="kv" style="margin-top:10px; grid-template-columns: auto 1fr; column-gap:16px;">
        <div class="metric-box">
          <span class="metric-sub">${isDiskMode()?'Orifice':'Nozzle'} ${unitPress}</span>
          <div class="metric-big">${p1NozDisp}</div>
        </div>

        <div class="metric-box">
          <span class="metric-sub">DC @ Max Speed</span>
          <div class="metric-big">${Math.round(r.dcVmax*100)}%</div>
        </div>

        <div class="label"><span>Speed Range @ P1</span></div>
        <div class="value"><strong>${
          isMetric() ? Math.round(sP1.vmin/MPH_PER_KPH) : Math.round(sP1.vmin)
        }–${
          isMetric() ? Math.round(sP1.v100/MPH_PER_KPH) : Math.round(sP1.v100)
        } ${isMetric()?'kph':'mph'}</strong></div>

        ${P2 ? `
        <div class="label"><span>Speed Range @ P2</span></div>
        <div class="value"><strong>${
          isMetric() ? Math.round(sP2.vmin/MPH_PER_KPH) : Math.round(sP2.vmin)
        }–${
          isMetric() ? Math.round(sP2.v100/MPH_PER_KPH) : Math.round(sP2.v100)
        } ${isMetric()?'kph':'mph'}</strong></div>
        ` : ''}
      </div>

      <div class="help" style="margin-top:8px;">${rationaleByPosition(i)}</div>
      <div class="help"><strong>Headroom at 100% DC</strong> — (${headroomStr})</div>

      <div id="${detailsId}" style="display:none; margin-top:10px;">
        <div class="help" style="margin-bottom:6px;">Detailed speeds by duty cycle</div>
        <div style="overflow:auto;">
          <table class="table" style="margin:0;">
            <thead>
              <tr>
                <th>Boom Pressure</th>
                <th>${isDiskMode()?'Orifice Disk':'Size • Color'}</th>
                <th>${isDiskMode()?'Orifice Pressure':'Nozzle Pressure'}</th>
                <th>Speed @DC10</th>
                <th>Speed @DC25</th>
                <th>Speed @DC50</th>
                <th>Speed @DC75</th>
                <th>Speed @DC100</th>
              </tr>
            </thead>
            <tbody>
              ${buildDetailsTableRows(appType, rate, spacingIn, sg, valve, r.nz, P1, true)}
              ${P2 ? buildDetailsTableRows(appType, rate, spacingIn, sg, valve, r.nz, P2, true) : ''}
            </tbody>
          </table>
        </div>
      </div>
    `;

    card.addEventListener('click', (e)=>{
      if(e.target.closest('button, a, input, select, label')) return;
      const det = document.getElementById(detailsId);
      if(det) det.style.display = (det.style.display==='none' ? '' : 'none');
      updateAdvStickyOffsets();
    });

    wrap.appendChild(card);
  });
}

function renderTable(){
  const tbody = $('resultsTable').querySelector('tbody');
  tbody.innerHTML='';

  const appType = $('appType').value;
  const rate = getRateUS();
  const spacingIn = getSpacingInches();
  const valve = VALVES[$('valveFamily').value];
  const sg = toNum($('sg').value, 1.0);
  const vmax = getVmaxMph();
  const dcMin = Math.max(0, Math.min(1, toNum($('dcmin').value, 25)/100));

  // pressures
  let pressuresPsi = pressureStepsForTable(appType);
  const customPb = displayToPsi($('customPb').value);
  if(customPb > 0){ pressuresPsi = [customPb]; }

  const outlets = buildOutletList(true);

  // Read selected filters
  const selected = getSelectedFilterValues();
  const showAll = selected.length === 0;

  let rowIndex = 0;
  // group alternation by disk id (Blue ⇄ White)
  let lastDiskId = null;
  let groupIsBlue = true; // first seen disk group = Blue

  for(const nz of outlets){
    // filter by disk id or size depending on mode
    if(!showAll){
      if(isDiskMode()){
        if(!selected.includes(getOutletName(nz))) continue;
      } else {
        if(!selected.includes(nz.size)) continue;
      }
    }

    // if disk mode, flip group color when the disk changes
    if (isDiskMode()){
      const currId = getOutletName(nz); // e.g., "CP4916-65"
      if (currId !== lastDiskId){
        groupIsBlue = !groupIsBlue;   // flip when disk changes
        lastDiskId = currId;
      }
    }

    for(const pb of pressuresPsi){
      const Pn = nozzlePressureFromBoom(pb, nz.size, valve.Cv);
      const Qnoz = nozzleFlowAt(Pn, sg, nz.size);
      const {v100, vmin} = speedsFromQ(appType, rate, spacingIn, Qnoz, dcMin);
      const dcVmax = dutyAtSpeed(appType, rate, vmax, spacingIn, Qnoz);

      let fitLbl='Oversized', fitCls='warn';
      if(dcVmax > 1.0001){ fitLbl='Undersized'; fitCls='bad'; }
      else if(dcVmax >= 0.75){ fitLbl='At/Near'; fitCls='ok'; }

      const tr = document.createElement('tr');

      if(isDiskMode()){
        const rowClass = groupIsBlue ? 'disk-row-blue' : 'disk-row-white';
        const leftClass = groupIsBlue ? 'disk-left-blue' : 'disk-left-white';

        tr.className = rowClass;
        tr.innerHTML = `
          <td class="${leftClass}">${fmtPressureValueTable(pb)} ${displayPressureLabel()}</td>
          <td><span class="disk-pill">${getOutletName(nz)}</span><div class="hint">${fmtGpm40(getOutletSize(nz))}</div></td>
          <td>${fmtPressureValueTable(Pn)} ${displayPressureLabel()}</td>
          <td>${vmin>0? mphToDisplay(vmin).toFixed(2):'—'}</td>
          <td>${v100>0? mphToDisplay(v100).toFixed(2):'—'}</td>
          <td>${Math.round(dcVmax*100)}%</td>
          <td><span class="status ${fitCls}">${fitLbl}</span></td>
        `;
      } else {
        // nozzle mode — keep existing color usage
        const color = COLOR_MAP[nz.color] || nz.color || '#E5E7EB';
        const pressLabel = fmtPressureValueTable(pb) + ' ' + displayPressureLabel();
        const sizeLabel = nz.isCustom ? `${nz.size.toFixed(2)} • Custom Nozzle`
                                      : `${nz.size.toFixed(2)} • ${nz.color}`;

        tr.innerHTML = `
          <td style="border-left:6px solid ${color};">${pressLabel}</td>
          <td style="background:${color}20;">${sizeLabel}</td>
          <td>${fmtPressureValueTable(Pn)} ${displayPressureLabel()}</td>
          <td>${vmin>0? mphToDisplay(vmin).toFixed(2):'—'}</td>
          <td>${v100>0? mphToDisplay(v100).toFixed(2):'—'}</td>
          <td>${Math.round(dcVmax*100)}%</td>
          <td><span class="status ${fitCls}">${fitLbl}</span></td>
        `;
      }

      tbody.appendChild(tr);
      rowIndex++;
    }
  }
}

function populateSizeFilterPanel(){
  const host = document.getElementById('sizeFilterList'); 
  if(!host) return;
  host.innerHTML = '';

  const list = buildOutletList(true);
  const seen = new Set();

  if(isDiskMode()){
    // show IDs with a search box
    document.getElementById('sizeFilterSearchWrap').style.display = '';
    const ids = list.map(o=>getOutletName(o));
    ids.forEach(id=>{
      if(seen.has(id)) return; seen.add(id);
      const safe = id.replace(/[^a-zA-Z0-9_-]/g,'_');
      const row = document.createElement('label');
      row.setAttribute('for', `disk_${safe}`);
      row.innerHTML = `<input id="disk_${safe}" type="checkbox" value="${id}"> <span>${id}</span>`;
      host.appendChild(row);
    });

    const search = $('sizeFilterSearch');
    if(search){
      search.value = '';
      search.oninput = ()=>{
        const q = search.value.toLowerCase();
        host.querySelectorAll('label').forEach(l=>{
          const t = l.textContent.toLowerCase();
          l.style.display = t.includes(q) ? '' : 'none';
        });
      };
    }
  } else {
    // nozzle size list
    document.getElementById('sizeFilterSearchWrap').style.display = 'none';
    list.forEach(n => {
      if(seen.has(n.size)) return; 
      seen.add(n.size);

      const labelText = n.isCustom ? `${n.size.toFixed(2)} (Custom)` : n.size.toFixed(2);
      const id = `sizeOpt_${String(n.size).replace('.','_')}`;

      const row = document.createElement('label');
      row.setAttribute('for', id);
      row.innerHTML = `<input id="${id}" type="checkbox" value="${n.size}"> <span>${labelText}</span>`;
      host.appendChild(row);
    });
  }

  // label text for panel button
  const lbl = $('sizeFilterLabel');
  const btn = $('sizeFilterBtn');
  if(lbl) lbl.textContent = isDiskMode() ? 'Filter Disks' : 'Filter Nozzle Sizes';
  if(btn) btn.textContent = isDiskMode() ? 'Choose disks' : 'Choose sizes';
}

function getSelectedFilterValues(){
  const host = document.getElementById('sizeFilterList'); if(!host) return [];
  const vals = Array.from(host.querySelectorAll('input[type="checkbox"]:checked'))
              .map(cb => cb.value);
  // return as numbers for nozzle mode, strings for disk mode
  return isDiskMode() ? vals : vals.map(v=>parseFloat(v));
}

function updateSizeFilterSummary(){
  const sum = document.getElementById('sizeFilterSummary'); if(!sum) return;
  const v = getSelectedFilterValues();
  if(v.length===0){
    sum.textContent = isDiskMode() ? 'All disks shown' : 'All sizes shown';
  } else {
    sum.textContent = isDiskMode()
      ? `Showing: ${v.join(', ')}`
      : `Showing: ${v.map(x=>(+x).toFixed(2)).join(', ')}`;
  }
}

(function wireSizeFilter(){
  const btn = document.getElementById('sizeFilterBtn');
  const panel = document.getElementById('sizeFilterPanel');
  if(!btn || !panel) return;

  populateSizeFilterPanel();
  updateSizeFilterSummary();

  btn.addEventListener('click', ()=>{
    panel.classList.toggle('open');
  });

  document.getElementById('sizeFilterApply').addEventListener('click', ()=>{
    panel.classList.remove('open');
    updateSizeFilterSummary();
    renderTable();
  });

  document.getElementById('sizeFilterClear').addEventListener('click', ()=>{
    const host = document.getElementById('sizeFilterList');
    host.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false);
    panel.classList.remove('open');
    updateSizeFilterSummary();
    renderTable();
  });

  // Close on outside click
  document.addEventListener('click', (e)=>{
    if(!panel.classList.contains('open')) return;
    const wrap = document.getElementById('sizeFilterWrap');
    if(wrap && !wrap.contains(e.target)) panel.classList.remove('open');
  });
})();

document.getElementById('customNoz').addEventListener('input', ()=>{
  populateSizeFilterPanel();
  updateSizeFilterSummary();
  updateAdvStickyOffsets();
});

// P1/P2 helpers
function getP1Psi(){
  const cpPsi = displayToPsi($('customPb').value);
  if(cpPsi>0) return cpPsi;
  return getSelectedPsi($('boomPsi')) || 40;
}
function getP2Psi(){
  const vPsi = getSelectedPsi($('boomPsi2'));
  return (vPsi>0) ? vPsi : null;
}

function enableAdvTableWheelScroll(){
  const el = document.getElementById('advTableWrap');
  if(!el) return;
  if(el.__wheelBound) return;
  el.__wheelBound = true;

  el.addEventListener('wheel', (e)=>{
    // If mouse is over the scroll area, consume the wheel and scroll immediately
    const within = el.matches(':hover');
    const canScroll = el.scrollHeight > el.clientHeight;
    if(within && canScroll){
      e.preventDefault();            // require passive:false
      el.scrollTop += e.deltaY;
    }
    // otherwise let the page handle it
  }, { passive: false });
}


// Events
['appType','targetRate','spacingIn','valveFamily','boomPsi','boomPsi2','vmax','sg','dcmin','customPb','customNoz','outletType']
  .forEach(id=>{
    const el = $(id);
    if(!el) return;
    el.addEventListener('input', ()=>{
      if(id==='outletType'){
        // reset filter list and labels on switch
        populateSizeFilterPanel();
        updateSizeFilterSummary();
      }
      updateUnitLabels();
      recalc();
      updateAdvStickyOffsets();
    });
  });

['appType','valveFamily','boomPsi','boomPsi2','sg','outletType']
  .forEach(id=>{
    const el = $(id);
    if(!el) return;
    el.addEventListener('change', ()=>{
      if(id==='outletType'){
        populateSizeFilterPanel();
        updateSizeFilterSummary();
      }
      updateUnitLabels();
      recalc();
      updateAdvStickyOffsets();
    });
  });

$('unitSystem').addEventListener('change', ()=>{
  if(isMetric()){
    $('targetRate').value = '100';
    $('spacingIn').value  = '50';
    $('vmax').value       = '25';
  } else {
    $('targetRate').value = '10';
    $('spacingIn').value  = '20';
    $('vmax').value       = '18';
  }
  updateUnitLabels();
  recalc();
});

$('metricPressureUnit').addEventListener('change', ()=>{ updateUnitLabels(); recalc(); });
$('appType').addEventListener('change', ()=>{ updateUnitLabels(); recalc(); });

(function(){
  const modeSel = $('modeToggle');
  const advancedPanel = $('advancedPanel');
  function syncMode(){
    const on = (modeSel.value === 'advanced');
    advancedPanel.style.display = on ? '' : 'none';
    if(on){
      enableAdvTableWheelScroll();
    }
  }
  modeSel.addEventListener('change', syncMode);
  syncMode();
})();

function updateAdvStickyOffsets(){
  // no-op placeholder (kept from your previous file)
}

// Init
ensurePressureOptionsPSI();
updateUnitLabels();
recalc();
enableAdvTableWheelScroll();
updateAdvStickyOffsets();
document.getElementById('printBtn').addEventListener('click', () => window.print());
</script>
</body>
</html>
